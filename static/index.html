<!DOCTYPE html>
<html>
	<head>
	<!--
		// Copyright 2016 Zachary Giles
		// MIT License
		//
		// Please see the LICENSE file
	-->
	<meta charset="UTF-8" />
	<title>Sample of websocket with golang</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	<script>
	var universe = {}
	var badobjects = []
	var owneruuid = guid()
	var rendertimer;
	var updatetimer;
	var sendtimer;
	var ship = {
		uuid: guid(),
		owner: owneruuid,
		type: 'ship',
		global: [0,0],
		velocity: [0,0],
		fuel: 10,
		air: 20,
		angle: 5,
		angle_velocity: 8,
		thrusters: [
			{ type: "right", firing: 0},
			{ type: "left", firing: 0}
		],
		boost: 0,
		name: randomname()
	}

  function randomname() {
		return Math.random().toString(36).substring(7);
	}

	function guid() {
		function s4() {
			return Math.floor((1 + Math.random()) * 0x10000)
			.toString(16)
			.substring(1);
		}
		return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
		s4() + '-' + s4() + s4() + s4();
	}

	function updatemyship() {
		ship.global[0] = ship.global[0] + Math.floor(Math.random() * 1000 %1000)-500;
		ship.global[1] = ship.global[1] + Math.floor(Math.random() * 1000 %1000)-500;
		ship.velocity[0] = ship.velocity[0] + Math.floor(Math.random() * 1000 %1000)-500;
		ship.velocity[1] = ship.velocity[1] + Math.floor(Math.random() * 1000 %1000)-500;
		console.log(ship);
		render();
	}

	function render() {
		$('#shipspan').text(JSON.stringify(ship));
		$('#shiplist').html(Object.keys(universe).reduce(function(t, x) {
			return t + '<li>' + JSON.stringify(universe[x]) + '</li>';
		}, ''));
		$('#badobjects').text(JSON.stringify(badobjects));
	}

	function wrapmessage(o, mt) {
		if (mt == undefined) {
			mt = "SpaceObject"
		}
		return {
			messagetype: mt,
			o: o
		}
	}

	function unwrapmessages(o) {
		return (o != undefined && o.o != undefined) ? o.o : {}
	}

	$(function() {
		$('#owneruuid').text(owneruuid);

		// This simulates a normal background physics update and re-render
		// at different times and not the same as the updates coming off the web.
		rendertimer = setInterval(render, 100);
		updatetimer = setInterval(updatemyship, 1000);

		var socket = new WebSocket("ws://" + location.host + "/ws");

		socket.onopen = function() {
			console.log("WebSocket Open!");
			// This sends our data out every second.
			sendtimer = setInterval(function() {
				socket.send(JSON.stringify(wrapmessage(ship)));
				console.log('timer: sending ship');
			}, 1000);
		}

		socket.onmessage = function(e) {
			console.log(e);
			m = unwrapmessages(JSON.parse(e.data))
			console.log(m);
			if (m.uuid != undefined) {
				universe[m.uuid] = m;
			} else {
				badobjects.push(m)
			}
		}

		socket.onclose = function() {
			clearInterval(sendtimer);
			console.log("WebSocket Closed!");
		}

		$('#pushmyship').click(function() {
			socket.send(JSON.stringify(ship));
			console.log('sending ship');
		});

		$('#updatemyship').click(function() {
			updatemyship()
		});

	});

	</script>
	</head>
	<body>
		<h2>Your Owner UUID:</h2>
		<span id="owneruuid"></span>
		<h2>Your Ship:</h2>
		<span id="shipspan"></span><br/>
		<h2>Everyone Else's Ships:</h2>
		<ul id='shiplist'></ul>
		<h2>BadObjects:</h2>
		<ul id='badobjects'></ul>
	</body>
</html>
